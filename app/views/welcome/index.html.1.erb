<% 
require 'csv' 
require 'net/ftp'
require 'tempfile'
require "open-uri"
require 'rubygems'
%>

<% if user_signed_in?  %>
<P>@home  = <%= @home%></P>
<P>@printX  = <%= @printX%></P>
<%########URLs from controller with all the labels %>
<%=@hardcodedURLsC = @labelsArray2%>
<P>urls from VAR - = <%=@hardcodedURLsC%></P>
<P>from the DB urls = <%=@hardcodedURLsDB = Url.find_by_account_number(@accountNumber).urls%></p>
<P>is ftp2= <%##=IsFTp.find_by_account_number(@accountNumber).isFTP%></P>
<P>labelsArray2= <%=@labelsArray2%></P>
<P>enabling to print = <%=@printX%></P>
<P>deployment status = <%=@deployment%></P>
<P>server print = <%=@printServer = cookies[:print]%></P>
<P>csv Read = <%=@csvRead%></P>
<P>col 3 array T= <%=@col3T%></P>
<P>labels uri = <%=@labelURI%></P>
<P>debug1 = <%=@debug1%></P>
<P>@debug2  = <%=@debug2 %></P>
<P>@debug3  = <%= @debug3%></P>
<P>@debug4  = <%= @debug4%></P>
<P>@debug5  = <%= @debug5%></P>

   <script>

   
   //Save to JS string
   //////var cookiesLabelsArrayStringC = '<%############=@cookeslabelsArray2%>';
   var labelsArrayStringC = '<%=@hardcodedURLsC%>';
   var labelsArrayStringDB = '<%=@hardcodedURLsDB%>';
      //////console.log("labecookies label array string= "+cookiesLabelsArrayStringC);
      console.log("label DB label array string= "+labelsArrayStringDB);

   //Declare JS array
   var labelsArrayC;
   var labelsArrayDB;
  
      //////var cookiesLabelsArray;
   
 
  
  //Split the JS string into tan JS array
  labelsArrayC =  labelsArrayStringC.split("quot;");
  labelsArrayDB =  labelsArrayStringDB.split("quot;");
  

  
  console.log("label DB label array = "+labelsArrayDB);
   
     //////cookiesLabelsArrayC =  cookiesLabelsArrayStringC.split("quot;");
     
  //__________________________________________________________________________________________________________________________________
  //TRY getting info from cookies print and if true the runthis code
     //moving back to views - DEPLOYMENT - ************WORKS HEREE - Reads uptodate file
      //  var csvArrayOpen = '<%#= open('OurFormatTest.csv', 'r')%>';  
       // csvArrayOpen = '<%#= @file5JSx = open('https://label-gen-var3.herokuapp.com/uploads/resume/attachment/1/OurFormatTest.csv').read%>';
                 
    //console.log("csvArrayOpen = "+csvArrayOpen);
    
    //var csvReadJS = '<%#=CSV.read(@file5JSx)%>';
    
    

      var csvArrayOpen = '<%= open('OurFormatTest.csv', 'wb') do |file2|
                   file2 << open('https://label-gen-var3.herokuapp.com/uploads/resume/attachment/1/OurFormatTest.csv').read
                   @file5JSx = file2
                 end%>';
                 
    console.log("csvArrayOpen = "+csvArrayOpen);
    
    var csvReadJS = '<%=CSV.read(@file5JSx)%>';
    console.log("csvReadJS = "+csvReadJS); 
  
    var arrayJSfromRuby = [];
    
    var h =0;
    var csvLenghtJS = '<%=CSV.read(@file5JSx).length%>';
     console.log("csvLenghtJS = "+csvLenghtJS);
     
     if (csvLenghtJS > 1){
         
         <%=
                CSV.foreach(@file5JSx) do |row1|
                @csvColumn1 =  row1[0].inspect.gsub!('"', '') #+  @csvRow1.inspect 
                @csvColumn2 =  row1[1].inspect.gsub!('"', '') 
                @csvColumn3 =  row1[2].inspect.gsub!('"', '') 
                @csvColumn4 =  row1[3].inspect.gsub!('"', '') 
                @csvColumn5 =  row1[4].inspect.gsub!('"', '') 
                @csvColumn6 =  row1[5].inspect.gsub!('"', '')  
                @csvColumn7 =  row1[6].inspect.gsub!('"', '')  
                @csvColumn8 =  row1[7].inspect.gsub!('"', '')  
                @csvColumn9 =  row1[8].inspect.gsub!('"', '')  
                @csvColumn10 =  row1[9].inspect.gsub!('"', '')  
                @csvColumn11 =  row1[10].inspect.gsub!('"', '')  
                @csvColumn12 =  row1[11].inspect.gsub!('"', '')  
                @csvColumn13 =  row1[12].inspect.gsub!('"', '')  
                @csvColumn14 =  row1[13].inspect.gsub!('"', '')  
                @csvColumn24 =  row1[23].inspect.gsub!('"', '')  
                @csvColumn25 =  row1[24].inspect.gsub!('"', '')  
                @csvColumn26 =  row1[25].inspect.gsub!('"', '')  
                @csvColumn27 =  row1[26].inspect.gsub!('"', '') 
                @csvColumn30 =  row1[29].inspect.gsub!('"', '')  
                @csvColumn31 =  row1[30].inspect.gsub!('"', '')  
                @csvColumn32 =  row1[31].inspect.gsub!('"', '') 
                
                @csvArray2.push(@csvColumn3 )
                
                
                
                
                
                
                
                
                        
        @debug6 = true

        @mapping_array = [@csvColumn1,  @csvColumn2,  @csvColumn3,  @csvColumn4, 
               @csvColumn5,  @csvColumn6,  @csvColumn7,  @csvColumn8,
               @csvColumn9,  @csvColumn10, @csvColumn11, @csvColumn12, 
               @csvColumn13, @csvColumn14, @csvColumn15, @csvColumn16,
               @csvColumn17, @csvColumn18, @csvColumn19, @csvColumn20,
               @csvColumn21, @csvColumn22, @csvColumn23, @csvColumn24, 
               @csvColumn25, @csvColumn26, @csvColumn27, @csvColumn28,  
               @csvColumn29, @csvColumn30, @csvColumn31, @csvColumn32, 
               @csvColumn33, @csvColumn34, @csvColumn35, @csvColumn36,
               @csvColumn37, @csvColumn38, @csvColumn39, @csvColumn40,
               @csvColumn41, @csvColumn42, @csvColumn43, @csvColumn44,
               @csvColumn45, @csvColumn46, @csvColumn47, @csvColumn48, 
               @csvColumn49, @csvColumn50]

          
          
        #Mappings_____________________________________________________________BEGIN
        #all the colums from the DB  -  Mapping for that particular account
        @mappings = Mapping.find_by_account_number(@accountNumber)
        @debug7 = true
        #if no mapping was created yet then use the default
        if @mappings.nil?
            @a1= 1
            @b2= 2
            @c3= 3
            @d4= 4
            @e5= 5
            @f6= 6
            @g7= 7
            @h8= 8
            @i9= 9
            @j10= 10
            
            @k11= 11
            @l12= 12
            @m13= 13
            @n14= 14
            @o15= 15
            @p16= 16
            @q17= 17
            @r18= 18
            @s19= 19
            @t20= 20
            
            @u21= 21
            @v22= 22
            @w23= 23
            @x24= 24
            @y25= 25
            @z26= 26
            @aa27= 27
            @ab28= 28
            @ac29= 29
            @ad30= 30
            
            @ae31= 31
            @af32= 32
            @ag33= 33
            @ah34= 34
            @ai35= 35
            @aj36= 36
            @ak37= 37
            @al38= 38
            @am39= 39
            @an40= 40
            
            @ao41= 41
            @ap42= 42
            @aq43= 43
            @ar44= 44
            @as45= 45
            @at46= 46
            @au47= 47
            @av48= 48
            @aw49= 49
            @ax50= 50
        
        
        else
            @a1= @mappings.a1
            @b2= @mappings.b2
            @c3= @mappings.c3
            @d4= @mappings.d4
            @e5= @mappings.e5
            @f6= @mappings.f6
            @g7= @mappings.g7
            @h8= @mappings.h8
            @i9= @mappings.i9
            @j10= @mappings.j10
            
            @k11= @mappings.k11
            @l12= @mappings.l12
            @m13= @mappings.m13
            @n14= @mappings.n14
            @o15= @mappings.o15
            @p16= @mappings.p16
            @q17= @mappings.q17
            @r18= @mappings.r18
            @s19= @mappings.s19
            @t20= @mappings.t20
            
            @u21= @mappings.u21
            @v22= @mappings.v22
            @w23= @mappings.w23
            @x24= @mappings.x24
            @y25= @mappings.y25
            @z26= @mappings.z26
            @aa27= @mappings.aa27
            @ab28= @mappings.ab28
            @ac29= @mappings.ac29
            @ad30= @mappings.ad30
            
            @ae31= @mappings.ae31
            @af32= @mappings.af32
            @ag33= @mappings.ag33
            @ah34= @mappings.ah34
            @ai35= @mappings.ai35
            @aj36= @mappings.aj36
            @ak37= @mappings.ak37
            @al38= @mappings.al38
            @am39= @mappings.am39
            @an40= @mappings.an40
            
            @ao41= @mappings.ao41
            @ap42= @mappings.ap42
            @aq43= @mappings.aq43
            @ar44= @mappings.ar44
            @as45= @mappings.as45
            @at46= @mappings.at46
            @au47= @mappings.au47
            @av48= @mappings.av48
            @aw49= @mappings.aw49
            @ax50= @mappings.ax50
        end

        a = @a1
        b = @b2
        c = @c3
        d = @d4
        e = @e5
        f = @f6
        g = @g7
        h = @h8
        i = @i9
        j = @j10
        
        k = @k11
        l = @l12
        m = @m13
        n = @n14
        o= @o15 
        p = @p16
        q= @q17
        r= @r18
        s= @s19
        t= @t20
        
        u= @u21
        v= @v22
        w= @w23
        x = @x24
        y = @y25
        z = @z26
        aa = @aa27
        ab= @ab28
        ac= @ac29
        
        ad = @ad30
        ae = @ae31
        af = @af32
        ag= @ag33
        ah= @ah34
        ai= @ai35
        aj= @aj36
        ak= @ak37
        al= @al38
        am= @am39
        an= @an40
        
        ao= @ao41
        ap= @ap42
        aq= @aq43
        ar= @ar44
        as= @as45
        at= @at46
        au= @au47
        av= @av48
        aw= @aw49
        ax= @ax50
        
=begin  
          a = 1
          b = 2
          c = 3
          d = 4
          e = 5
          f = 6
          g = 7
          h = 8
          i = 9
          j = 10
          k = 11
          l = 12
          m = 13
          n = 14
          x = 24
          y = 25
          z = 26
          aa = 27
          ad = 30
          ae = 31
          af = 32
=end
#Mappings_____________________________________________________________END
          
          
        ##need to get the prin value from cookies to generate labels onclick.
                #get the authorise token
                xmlPayloadAuthorise = 
                '<?xml version="1.0" encoding="iso-8859-1"?>
                <Request>
                <User>'+@accountNumber+'</User>
                <Password>'+@password+'</Password>
                <Type>CUST</Type>
                </Request>'
                
                authorizeResponce = RestClient.post "https://papi.dpd.ie/common/api/authorize", xmlPayloadAuthorise, 
                {content_type: :xml, accept: :xml, authorization: 'Bearer '+@token+''}
                
                #parce the xml to get the access token
                xmlAuthorizeDoc  = Nokogiri::XML(authorizeResponce)
                #get the access token
                accessToken = xmlAuthorizeDoc.xpath("//AccessToken").text
                
                
                ######___________________________________MAPPING AN ARRAY_________________________________
                #@mapping_array[@xml_input_d.to_i-1]
                
                @A1 = @mapping_array[a-1]
                @A1= @A1.to_s
                
                @C3 = @mapping_array[c-1]
                @C3= @C3.to_s
                
                @D4 = @mapping_array[d-1]
                @D4= @D4.to_s
                
                @E5 = @mapping_array[e-1]
                @E5= @E5.to_s
                
                @F6 = @mapping_array[f-1]
                @F6= @F6.to_s
                
                @G7 = @mapping_array[g-1]
                @G7= @G7.to_s
                
                @H8 = @mapping_array[h-1]
                @H8= @H8.to_s
                
                
                @I9 = @mapping_array[i-1]
                @I9= @I9.to_s
                
                @J10 = @mapping_array
                @J10= @J10.to_s
                
                @K11 = @mapping_array[k-1]
                @K11= @K11.to_s
                
                @L12 = @mapping_array[l-1]
                @L12= @L12.to_s
                
                @M13 = @mapping_array[g-1]
                @M13= @M13.to_s
                
                @N14 = @mapping_array[m-1]
                @N14= @N14.to_s
                
                
                
                @X24 = @mapping_array[x-1]
                @X24= @X24.to_s
                
                @Y25 = @mapping_array[y-1]
                @Y25= @Y25.to_s
                
                @Z26 = @mapping_array[z-1]
                @Z26= @Z26.to_s
                
                @AA27 = @mapping_array[aa-1]
                @AA27= @AA27.to_s
                
                @AD30 = @mapping_array[ad-1]
                @AD30= @AD30.to_s
                
                                  
                  #user_input_mapping = change all to integers
                
                  
                 
                xmlPayloadAuthorised = 
                '<?xml version="1.0" encoding="iso-8859-1"?>
                <PreAdvice>
                    <Consignment>
                        <RecordID>'+ @A1 +  '</RecordID>
                        <AlertEmailAddress>'+ @AD30 +  '</AlertEmailAddress>
                        <ConsignmentDescription>LG.124132D</ConsignmentDescription>
                        <ConsignmentDate>2018-12-03</ConsignmentDate>
                        <CustomerAccount>1111L1</CustomerAccount>
                        <DeliveryDepot>0</DeliveryDepot>
                        <Gazzed>0</Gazzed>
                        <GazzType>PreAdvice</GazzType>
                        <TrackingNumber>0</TrackingNumber>
                        <TotalParcels>1</TotalParcels>
                        <Relabel>1</Relabel>
                        <ServiceOption>5</ServiceOption>
                        <ServiceType>1</ServiceType>
                        <Weight>10</Weight>
                        <DeliveryAddress>
                            <Contact>'+ @X24 +'</Contact>
                            <ContactTelephone>'+@Y25  +'</ContactTelephone>
                            <ContactEmail>'+@AD30  +'</ContactEmail>
                            <BusinessName>'+@C3  +'</BusinessName>
                            <AddressLine1>'+@D4  +'</AddressLine1>
                            <AddressLine2>'+@E5  +'</AddressLine2>
                            <AddressLine3>'+@F6  +'</AddressLine3>
                            <AddressLine4>'+@G7 +'</AddressLine4>
                            <PostCode>'+@H8 +'</PostCode>
                            <CountryCode>'+@I9 +'</CountryCode>
                        </DeliveryAddress>
                        <CollectionAddress>
                           <Contact>'+@X24  +'</Contact>
                            <ContactTelephone>'+@Y25  +'</ContactTelephone>
                            <ContactEmail>'+@AD30  +'</ContactEmail>
                            <BusinessName>'+ @C3  +'</BusinessName>
                            <AddressLine1>'+@D4  +'</AddressLine1>
                            <AddressLine2>'+@E5  +'</AddressLine2>
                            <AddressLine3>'+@F6  +'</AddressLine3>
                            <AddressLine4>'+@G7 +'</AddressLine4>
                            <PostCode>'+@H8 +'</PostCode>
                            <CountryCode>>'+@I9 +'</CountryCode>
                        </CollectionAddress>
                        <References>
                            <Reference>
                                <ReferenceName>name</ReferenceName>
                                <ReferenceValue>'+@Z26 +'</ReferenceValue>
                                <ParcelNumber>1</ParcelNumber>
                            </Reference>
                            <Reference>
                                <ReferenceName>ref3</ReferenceName>
                                <ReferenceValue>'+@AA27 +'</ReferenceValue>
                                <ParcelNumber>2</ParcelNumber>
                            </Reference>
                        </References>
                    </Consignment>
                </PreAdvice>'
               
                
        if cookies[:print] == 'true' 
                labelResponse = RestClient.post "https://papi.dpd.ie/common/api/preadvice", xmlPayloadAuthorised, 
                {content_type: :xml, accept: :xml, authorization: "Bearer " + accessToken}
                
                #parce the xml to get the access token
                xmlLabelDoc  = Nokogiri::XML(labelResponse)
                #get the access token
                @labelURI = xmlLabelDoc.xpath("//LabelImage").text
                
                @responseXML = xmlLabelDoc
                
                 
                ###############
                ####redirects to url with a label
                
             
                @labelsArray2.push(@labelURI)
            end    
                ###@labelsArrayDB = @labelsArrayDB +" "+ @labelURI
                ##@labelsArrayDB =  @labelURI +'~'+ @labelURI
                 ### @labelsArrayDB = @labelsArray2.map(&:inspect).join('') 
                 
            
                
                #######cookies[:cookeslabelsArray2] = cookies[:cookeslabelsArray2] +'~'+ @labelURI
                @debug10 = true
                
                ##################
            end
    %>
         
     }
     
     
     //**WORKS but generates labels on restart
     console.log('array now = '+'<%=@labelsArray2%>');
      console.log('cookies on gen------ = '+'<%=cookies[:print] %>');
      <%=cookies[:print] = "false" %>
     //__________________________________________________________________________________________________________________________________

/*     
     if (csvLenghtJS > 1){
    while (h <= csvLenghtJS){
        arrayJSfromRuby.push('<%##=@csvColumn1 = CSV.read(@file5JS)[@csvReadJS.length-@csvReadJS.length][0].inspect.gsub!('"', '')%>');
        arrayJSfromRuby.push('<%##=CSV.read(@file5JS)[0][1].inspect.gsub!('"', '')%>');
        arrayJSfromRuby.push('<%##=CSV.read(@file5JS)[0][2].inspect.gsub!('"', '')%>');
        arrayJSfromRuby.push('<%##=CSV.read(@file5JS)[0][3].inspect.gsub!('"', '')%>');
         
         h = h+1;
    }
    console.log("arrayJSfromRuby = "+arrayJSfromRuby);
     }
     */

/*   
 
 
     CSV.foreach(@file5JS) do |row1|
                @csvColumn1 =  row1[0].inspect.gsub!('"', '') #+  @csvRow1.inspect 
                @csvColumn2 =  row1[1].inspect.gsub!('"', '') 
                @csvColumn3 =  row1[2].inspect.gsub!('"', '') 
                @csvColumn4 =  row1[3].inspect.gsub!('"', '') 
                @csvColumn5 =  row1[4].inspect.gsub!('"', '') 
                @csvColumn6 =  row1[5].inspect.gsub!('"', '')  
                @csvColumn7 =  row1[6].inspect.gsub!('"', '')  
                @csvColumn8 =  row1[7].inspect.gsub!('"', '')  
                @csvColumn9 =  row1[8].inspect.gsub!('"', '')  
                @csvColumn10 =  row1[9].inspect.gsub!('"', '')  
                @csvColumn11 =  row1[10].inspect.gsub!('"', '')  
                @csvColumn12 =  row1[11].inspect.gsub!('"', '')  
                @csvColumn13 =  row1[12].inspect.gsub!('"', '')  
                @csvColumn14 =  row1[13].inspect.gsub!('"', '')  
                @csvColumn24 =  row1[23].inspect.gsub!('"', '')  
                @csvColumn25 =  row1[24].inspect.gsub!('"', '')  
                @csvColumn26 =  row1[25].inspect.gsub!('"', '')  
                @csvColumn27 =  row1[26].inspect.gsub!('"', '') 
                @csvColumn30 =  row1[29].inspect.gsub!('"', '')  
                @csvColumn31 =  row1[30].inspect.gsub!('"', '')  
                @csvColumn32 =  row1[31].inspect.gsub!('"', '') 
                
end
          
=begin                  
                @csvArray2.push(@csvColumn3 )
                
                
              
                
                
                
                
                
                        
        @debug6 = true

        @mapping_array = [@csvColumn1,  @csvColumn2,  @csvColumn3,  @csvColumn4, 
               @csvColumn5,  @csvColumn6,  @csvColumn7,  @csvColumn8,
               @csvColumn9,  @csvColumn10, @csvColumn11, @csvColumn12, 
               @csvColumn13, @csvColumn14, @csvColumn15, @csvColumn16,
               @csvColumn17, @csvColumn18, @csvColumn19, @csvColumn20,
               @csvColumn21, @csvColumn22, @csvColumn23, @csvColumn24, 
               @csvColumn25, @csvColumn26, @csvColumn27, @csvColumn28,  
               @csvColumn29, @csvColumn30, @csvColumn31, @csvColumn32, 
               @csvColumn33, @csvColumn34, @csvColumn35, @csvColumn36,
               @csvColumn37, @csvColumn38, @csvColumn39, @csvColumn40,
               @csvColumn41, @csvColumn42, @csvColumn43, @csvColumn44,
               @csvColumn45, @csvColumn46, @csvColumn47, @csvColumn48, 
               @csvColumn49, @csvColumn50]
          
        #Mappings_____________________________________________________________BEGIN
        #all the colums from the DB  -  Mapping for that particular account
        @mappings = Mapping.find_by_account_number(@accountNumber)
        @debug7 = true
        #if no mapping was created yet then use the default
        if @mappings.nil?
            @a1= 1
            @b2= 2
            @c3= 3
            @d4= 4
            @e5= 5
            @f6= 6
            @g7= 7
            @h8= 8
            @i9= 9
            @j10= 10
            
            @k11= 11
            @l12= 12
            @m13= 13
            @n14= 14
            @o15= 15
            @p16= 16
            @q17= 17
            @r18= 18
            @s19= 19
            @t20= 20
            
            @u21= 21
            @v22= 22
            @w23= 23
            @x24= 24
            @y25= 25
            @z26= 26
            @aa27= 27
            @ab28= 28
            @ac29= 29
            @ad30= 30
            
            @ae31= 31
            @af32= 32
            @ag33= 33
            @ah34= 34
            @ai35= 35
            @aj36= 36
            @ak37= 37
            @al38= 38
            @am39= 39
            @an40= 40
            
            @ao41= 41
            @ap42= 42
            @aq43= 43
            @ar44= 44
            @as45= 45
            @at46= 46
            @au47= 47
            @av48= 48
            @aw49= 49
            @ax50= 50
        
        
        else
            @a1= @mappings.a1
            @b2= @mappings.b2
            @c3= @mappings.c3
            @d4= @mappings.d4
            @e5= @mappings.e5
            @f6= @mappings.f6
            @g7= @mappings.g7
            @h8= @mappings.h8
            @i9= @mappings.i9
            @j10= @mappings.j10
            
            @k11= @mappings.k11
            @l12= @mappings.l12
            @m13= @mappings.m13
            @n14= @mappings.n14
            @o15= @mappings.o15
            @p16= @mappings.p16
            @q17= @mappings.q17
            @r18= @mappings.r18
            @s19= @mappings.s19
            @t20= @mappings.t20
            
            @u21= @mappings.u21
            @v22= @mappings.v22
            @w23= @mappings.w23
            @x24= @mappings.x24
            @y25= @mappings.y25
            @z26= @mappings.z26
            @aa27= @mappings.aa27
            @ab28= @mappings.ab28
            @ac29= @mappings.ac29
            @ad30= @mappings.ad30
            
            @ae31= @mappings.ae31
            @af32= @mappings.af32
            @ag33= @mappings.ag33
            @ah34= @mappings.ah34
            @ai35= @mappings.ai35
            @aj36= @mappings.aj36
            @ak37= @mappings.ak37
            @al38= @mappings.al38
            @am39= @mappings.am39
            @an40= @mappings.an40
            
            @ao41= @mappings.ao41
            @ap42= @mappings.ap42
            @aq43= @mappings.aq43
            @ar44= @mappings.ar44
            @as45= @mappings.as45
            @at46= @mappings.at46
            @au47= @mappings.au47
            @av48= @mappings.av48
            @aw49= @mappings.aw49
            @ax50= @mappings.ax50
        end

        a = @a1
        b = @b2
        c = @c3
        d = @d4
        e = @e5
        f = @f6
        g = @g7
        h = @h8
        i = @i9
        j = @j10
        
        k = @k11
        l = @l12
        m = @m13
        n = @n14
        o= @o15 
        p = @p16
        q= @q17
        r= @r18
        s= @s19
        t= @t20
        
        u= @u21
        v= @v22
        w= @w23
        x = @x24
        y = @y25
        z = @z26
        aa = @aa27
        ab= @ab28
        ac= @ac29
        
        ad = @ad30
        ae = @ae31
        af = @af32
        ag= @ag33
        ah= @ah34
        ai= @ai35
        aj= @aj36
        ak= @ak37
        al= @al38
        am= @am39
        an= @an40
        
        ao= @ao41
        ap= @ap42
        aq= @aq43
        ar= @ar44
        as= @as45
        at= @at46
        au= @au47
        av= @av48
        aw= @aw49
        ax= @ax50
        
=begin  
          a = 1
          b = 2
          c = 3
          d = 4
          e = 5
          f = 6
          g = 7
          h = 8
          i = 9
          j = 10
          k = 11
          l = 12
          m = 13
          n = 14
          x = 24
          y = 25
          z = 26
          aa = 27
          ad = 30
          ae = 31
          af = 32
=end
#Mappings_____________________________________________________________END


=begin
                #get the authorise token
                xmlPayloadAuthorise = 
                '<?xml version="1.0" encoding="iso-8859-1"?>
                <Request>
                <User>'+@accountNumber+'</User>
                <Password>'+@password+'</Password>
                <Type>CUST</Type>
                </Request>'
                
                authorizeResponce = RestClient.post "https://papi.dpd.ie/common/api/authorize", xmlPayloadAuthorise, 
                {content_type: :xml, accept: :xml, authorization: 'Bearer '+@token+''}
                
                #parce the xml to get the access token
                xmlAuthorizeDoc  = Nokogiri::XML(authorizeResponce)
                #get the access token
                accessToken = xmlAuthorizeDoc.xpath("//AccessToken").text
                
                
                ######___________________________________MAPPING AN ARRAY_________________________________
                #@mapping_array[@xml_input_d.to_i-1]
                
                @A1 = @mapping_array[a-1]
                @A1= @A1.to_s
                
                @C3 = @mapping_array[c-1]
                @C3= @C3.to_s
                
                @D4 = @mapping_array[d-1]
                @D4= @D4.to_s
                
                @E5 = @mapping_array[e-1]
                @E5= @E5.to_s
                
                @F6 = @mapping_array[f-1]
                @F6= @F6.to_s
                
                @G7 = @mapping_array[g-1]
                @G7= @G7.to_s
                
                @H8 = @mapping_array[h-1]
                @H8= @H8.to_s
                
                
                @I9 = @mapping_array[i-1]
                @I9= @I9.to_s
                
                @J10 = @mapping_array
                @J10= @J10.to_s
                
                @K11 = @mapping_array[k-1]
                @K11= @K11.to_s
                
                @L12 = @mapping_array[l-1]
                @L12= @L12.to_s
                
                @M13 = @mapping_array[g-1]
                @M13= @M13.to_s
                
                @N14 = @mapping_array[m-1]
                @N14= @N14.to_s
                
                
                
                @X24 = @mapping_array[x-1]
                @X24= @X24.to_s
                
                @Y25 = @mapping_array[y-1]
                @Y25= @Y25.to_s
                
                @Z26 = @mapping_array[z-1]
                @Z26= @Z26.to_s
                
                @AA27 = @mapping_array[aa-1]
                @AA27= @AA27.to_s
                
                @AD30 = @mapping_array[ad-1]
                @AD30= @AD30.to_s
                
                                  
                  #user_input_mapping = change all to integers
                
                  
                 
                xmlPayloadAuthorised = 
                '<?xml version="1.0" encoding="iso-8859-1"?>
                <PreAdvice>
                    <Consignment>
                        <RecordID>'+ @A1 +  '</RecordID>
                        <AlertEmailAddress>'+ @AD30 +  '</AlertEmailAddress>
                        <ConsignmentDescription>LG.124132D</ConsignmentDescription>
                        <ConsignmentDate>2018-12-03</ConsignmentDate>
                        <CustomerAccount>1111L1</CustomerAccount>
                        <DeliveryDepot>0</DeliveryDepot>
                        <Gazzed>0</Gazzed>
                        <GazzType>PreAdvice</GazzType>
                        <TrackingNumber>0</TrackingNumber>
                        <TotalParcels>1</TotalParcels>
                        <Relabel>1</Relabel>
                        <ServiceOption>5</ServiceOption>
                        <ServiceType>1</ServiceType>
                        <Weight>10</Weight>
                        <DeliveryAddress>
                            <Contact>'+ @X24 +'</Contact>
                            <ContactTelephone>'+@Y25  +'</ContactTelephone>
                            <ContactEmail>'+@AD30  +'</ContactEmail>
                            <BusinessName>'+@C3  +'</BusinessName>
                            <AddressLine1>'+@D4  +'</AddressLine1>
                            <AddressLine2>'+@E5  +'</AddressLine2>
                            <AddressLine3>'+@F6  +'</AddressLine3>
                            <AddressLine4>'+@G7 +'</AddressLine4>
                            <PostCode>'+@H8 +'</PostCode>
                            <CountryCode>'+@I9 +'</CountryCode>
                        </DeliveryAddress>
                        <CollectionAddress>
                           <Contact>'+@X24  +'</Contact>
                            <ContactTelephone>'+@Y25  +'</ContactTelephone>
                            <ContactEmail>'+@AD30  +'</ContactEmail>
                            <BusinessName>'+ @C3  +'</BusinessName>
                            <AddressLine1>'+@D4  +'</AddressLine1>
                            <AddressLine2>'+@E5  +'</AddressLine2>
                            <AddressLine3>'+@F6  +'</AddressLine3>
                            <AddressLine4>'+@G7 +'</AddressLine4>
                            <PostCode>'+@H8 +'</PostCode>
                            <CountryCode>>'+@I9 +'</CountryCode>
                        </CollectionAddress>
                        <References>
                            <Reference>
                                <ReferenceName>name</ReferenceName>
                                <ReferenceValue>'+@Z26 +'</ReferenceValue>
                                <ParcelNumber>1</ParcelNumber>
                            </Reference>
                            <Reference>
                                <ReferenceName>ref3</ReferenceName>
                                <ReferenceValue>'+@AA27 +'</ReferenceValue>
                                <ParcelNumber>2</ParcelNumber>
                            </Reference>
                        </References>
                    </Consignment>
                </PreAdvice>'
                
                labelResponse = RestClient.post "https://papi.dpd.ie/common/api/preadvice", xmlPayloadAuthorised, 
                {content_type: :xml, accept: :xml, authorization: "Bearer " + accessToken}
                
                #parce the xml to get the access token
                xmlLabelDoc  = Nokogiri::XML(labelResponse)
                #get the access token
                @labelURI = xmlLabelDoc.xpath("//LabelImage").text
                
                @responseXML = xmlLabelDoc
                
                 
                ###############
                ####redirects to url with a label
                
                
                @labelsArray2.push(@labelURI)
                ###@labelsArrayDB = @labelsArrayDB +" "+ @labelURI
                ##@labelsArrayDB =  @labelURI +'~'+ @labelURI
                 ### @labelsArrayDB = @labelsArray2.map(&:inspect).join('') 
                 
            
                
                #######cookies[:cookeslabelsArray2] = cookies[:cookeslabelsArray2] +'~'+ @labelURI
                @debug10 = true
                
                ##################
    
end
    
=end   
    %>';
 */   
    
     console.log("arrayJSfromRuby = "+arrayJSfromRuby);   
/*    
    
        
            #read ech column and save it to a variable
            CSV.foreach(@file5) do |row1|
                @csvColumn1 =  row1[0].inspect.gsub!('"', '') #+  @csvRow1.inspect 
                @csvColumn2 =  row1[1].inspect.gsub!('"', '') 
                @csvColumn3 =  row1[2].inspect.gsub!('"', '') 
                @csvColumn4 =  row1[3].inspect.gsub!('"', '') 
                @csvColumn5 =  row1[4].inspect.gsub!('"', '') 
                @csvColumn6 =  row1[5].inspect.gsub!('"', '')  
                @csvColumn7 =  row1[6].inspect.gsub!('"', '')  
                @csvColumn8 =  row1[7].inspect.gsub!('"', '')  
                @csvColumn9 =  row1[8].inspect.gsub!('"', '')  
                @csvColumn10 =  row1[9].inspect.gsub!('"', '')  
                @csvColumn11 =  row1[10].inspect.gsub!('"', '')  
                @csvColumn12 =  row1[11].inspect.gsub!('"', '')  
                @csvColumn13 =  row1[12].inspect.gsub!('"', '')  
                @csvColumn14 =  row1[13].inspect.gsub!('"', '')  
                @csvColumn24 =  row1[23].inspect.gsub!('"', '')  
                @csvColumn25 =  row1[24].inspect.gsub!('"', '')  
                @csvColumn26 =  row1[25].inspect.gsub!('"', '')  
                @csvColumn27 =  row1[26].inspect.gsub!('"', '') 
                @csvColumn30 =  row1[29].inspect.gsub!('"', '')  
                @csvColumn31 =  row1[30].inspect.gsub!('"', '')  
                @csvColumn32 =  row1[31].inspect.gsub!('"', '') 
                
                @csvArray2.push(@csvColumn3 )
                
                
                
                
                
                
                
                
                        
        @debug6 = true

        @mapping_array = [@csvColumn1,  @csvColumn2,  @csvColumn3,  @csvColumn4, 
               @csvColumn5,  @csvColumn6,  @csvColumn7,  @csvColumn8,
               @csvColumn9,  @csvColumn10, @csvColumn11, @csvColumn12, 
               @csvColumn13, @csvColumn14, @csvColumn15, @csvColumn16,
               @csvColumn17, @csvColumn18, @csvColumn19, @csvColumn20,
               @csvColumn21, @csvColumn22, @csvColumn23, @csvColumn24, 
               @csvColumn25, @csvColumn26, @csvColumn27, @csvColumn28,  
               @csvColumn29, @csvColumn30, @csvColumn31, @csvColumn32, 
               @csvColumn33, @csvColumn34, @csvColumn35, @csvColumn36,
               @csvColumn37, @csvColumn38, @csvColumn39, @csvColumn40,
               @csvColumn41, @csvColumn42, @csvColumn43, @csvColumn44,
               @csvColumn45, @csvColumn46, @csvColumn47, @csvColumn48, 
               @csvColumn49, @csvColumn50]

          
          
        #Mappings_____________________________________________________________BEGIN
        #all the colums from the DB  -  Mapping for that particular account
        @mappings = Mapping.find_by_account_number(@accountNumber)
        @debug7 = true
        #if no mapping was created yet then use the default
        if @mappings.nil?
            @a1= 1
            @b2= 2
            @c3= 3
            @d4= 4
            @e5= 5
            @f6= 6
            @g7= 7
            @h8= 8
            @i9= 9
            @j10= 10
            
            @k11= 11
            @l12= 12
            @m13= 13
            @n14= 14
            @o15= 15
            @p16= 16
            @q17= 17
            @r18= 18
            @s19= 19
            @t20= 20
            
            @u21= 21
            @v22= 22
            @w23= 23
            @x24= 24
            @y25= 25
            @z26= 26
            @aa27= 27
            @ab28= 28
            @ac29= 29
            @ad30= 30
            
            @ae31= 31
            @af32= 32
            @ag33= 33
            @ah34= 34
            @ai35= 35
            @aj36= 36
            @ak37= 37
            @al38= 38
            @am39= 39
            @an40= 40
            
            @ao41= 41
            @ap42= 42
            @aq43= 43
            @ar44= 44
            @as45= 45
            @at46= 46
            @au47= 47
            @av48= 48
            @aw49= 49
            @ax50= 50
        
        
        else
            @a1= @mappings.a1
            @b2= @mappings.b2
            @c3= @mappings.c3
            @d4= @mappings.d4
            @e5= @mappings.e5
            @f6= @mappings.f6
            @g7= @mappings.g7
            @h8= @mappings.h8
            @i9= @mappings.i9
            @j10= @mappings.j10
            
            @k11= @mappings.k11
            @l12= @mappings.l12
            @m13= @mappings.m13
            @n14= @mappings.n14
            @o15= @mappings.o15
            @p16= @mappings.p16
            @q17= @mappings.q17
            @r18= @mappings.r18
            @s19= @mappings.s19
            @t20= @mappings.t20
            
            @u21= @mappings.u21
            @v22= @mappings.v22
            @w23= @mappings.w23
            @x24= @mappings.x24
            @y25= @mappings.y25
            @z26= @mappings.z26
            @aa27= @mappings.aa27
            @ab28= @mappings.ab28
            @ac29= @mappings.ac29
            @ad30= @mappings.ad30
            
            @ae31= @mappings.ae31
            @af32= @mappings.af32
            @ag33= @mappings.ag33
            @ah34= @mappings.ah34
            @ai35= @mappings.ai35
            @aj36= @mappings.aj36
            @ak37= @mappings.ak37
            @al38= @mappings.al38
            @am39= @mappings.am39
            @an40= @mappings.an40
            
            @ao41= @mappings.ao41
            @ap42= @mappings.ap42
            @aq43= @mappings.aq43
            @ar44= @mappings.ar44
            @as45= @mappings.as45
            @at46= @mappings.at46
            @au47= @mappings.au47
            @av48= @mappings.av48
            @aw49= @mappings.aw49
            @ax50= @mappings.ax50
        end

        a = @a1
        b = @b2
        c = @c3
        d = @d4
        e = @e5
        f = @f6
        g = @g7
        h = @h8
        i = @i9
        j = @j10
        
        k = @k11
        l = @l12
        m = @m13
        n = @n14
        o= @o15 
        p = @p16
        q= @q17
        r= @r18
        s= @s19
        t= @t20
        
        u= @u21
        v= @v22
        w= @w23
        x = @x24
        y = @y25
        z = @z26
        aa = @aa27
        ab= @ab28
        ac= @ac29
        
        ad = @ad30
        ae = @ae31
        af = @af32
        ag= @ag33
        ah= @ah34
        ai= @ai35
        aj= @aj36
        ak= @ak37
        al= @al38
        am= @am39
        an= @an40
        
        ao= @ao41
        ap= @ap42
        aq= @aq43
        ar= @ar44
        as= @as45
        at= @at46
        au= @au47
        av= @av48
        aw= @aw49
        ax= @ax50
        
=begin  
          a = 1
          b = 2
          c = 3
          d = 4
          e = 5
          f = 6
          g = 7
          h = 8
          i = 9
          j = 10
          k = 11
          l = 12
          m = 13
          n = 14
          x = 24
          y = 25
          z = 26
          aa = 27
          ad = 30
          ae = 31
          af = 32
=end
#Mappings_____________________________________________________________END
          
          
        ##need to get the prin value from cookies to generate labels onclick.
        @debug8 = true
        
       
                @print = true
               
        
                @debug9 = true
                #get the authorise token
                xmlPayloadAuthorise = 
                '<?xml version="1.0" encoding="iso-8859-1"?>
                <Request>
                <User>'+@accountNumber+'</User>
                <Password>'+@password+'</Password>
                <Type>CUST</Type>
                </Request>'
                
                authorizeResponce = RestClient.post "https://papi.dpd.ie/common/api/authorize", xmlPayloadAuthorise, 
                {content_type: :xml, accept: :xml, authorization: 'Bearer '+@token+''}
                
                #parce the xml to get the access token
                xmlAuthorizeDoc  = Nokogiri::XML(authorizeResponce)
                #get the access token
                accessToken = xmlAuthorizeDoc.xpath("//AccessToken").text
                
                
                ######___________________________________MAPPING AN ARRAY_________________________________
                #@mapping_array[@xml_input_d.to_i-1]
                
                @A1 = @mapping_array[a-1]
                @A1= @A1.to_s
                
                @C3 = @mapping_array[c-1]
                @C3= @C3.to_s
                
                @D4 = @mapping_array[d-1]
                @D4= @D4.to_s
                
                @E5 = @mapping_array[e-1]
                @E5= @E5.to_s
                
                @F6 = @mapping_array[f-1]
                @F6= @F6.to_s
                
                @G7 = @mapping_array[g-1]
                @G7= @G7.to_s
                
                @H8 = @mapping_array[h-1]
                @H8= @H8.to_s
                
                
                @I9 = @mapping_array[i-1]
                @I9= @I9.to_s
                
                @J10 = @mapping_array
                @J10= @J10.to_s
                
                @K11 = @mapping_array[k-1]
                @K11= @K11.to_s
                
                @L12 = @mapping_array[l-1]
                @L12= @L12.to_s
                
                @M13 = @mapping_array[g-1]
                @M13= @M13.to_s
                
                @N14 = @mapping_array[m-1]
                @N14= @N14.to_s
                
                
                
                @X24 = @mapping_array[x-1]
                @X24= @X24.to_s
                
                @Y25 = @mapping_array[y-1]
                @Y25= @Y25.to_s
                
                @Z26 = @mapping_array[z-1]
                @Z26= @Z26.to_s
                
                @AA27 = @mapping_array[aa-1]
                @AA27= @AA27.to_s
                
                @AD30 = @mapping_array[ad-1]
                @AD30= @AD30.to_s
                
                                  
                  #user_input_mapping = change all to integers
                
                  
                 
                xmlPayloadAuthorised = 
                '<?xml version="1.0" encoding="iso-8859-1"?>
                <PreAdvice>
                    <Consignment>
                        <RecordID>'+ @A1 +  '</RecordID>
                        <AlertEmailAddress>'+ @AD30 +  '</AlertEmailAddress>
                        <ConsignmentDescription>LG.124132D</ConsignmentDescription>
                        <ConsignmentDate>2018-12-03</ConsignmentDate>
                        <CustomerAccount>1111L1</CustomerAccount>
                        <DeliveryDepot>0</DeliveryDepot>
                        <Gazzed>0</Gazzed>
                        <GazzType>PreAdvice</GazzType>
                        <TrackingNumber>0</TrackingNumber>
                        <TotalParcels>1</TotalParcels>
                        <Relabel>1</Relabel>
                        <ServiceOption>5</ServiceOption>
                        <ServiceType>1</ServiceType>
                        <Weight>10</Weight>
                        <DeliveryAddress>
                            <Contact>'+ @X24 +'</Contact>
                            <ContactTelephone>'+@Y25  +'</ContactTelephone>
                            <ContactEmail>'+@AD30  +'</ContactEmail>
                            <BusinessName>'+@C3  +'</BusinessName>
                            <AddressLine1>'+@D4  +'</AddressLine1>
                            <AddressLine2>'+@E5  +'</AddressLine2>
                            <AddressLine3>'+@F6  +'</AddressLine3>
                            <AddressLine4>'+@G7 +'</AddressLine4>
                            <PostCode>'+@H8 +'</PostCode>
                            <CountryCode>'+@I9 +'</CountryCode>
                        </DeliveryAddress>
                        <CollectionAddress>
                           <Contact>'+@X24  +'</Contact>
                            <ContactTelephone>'+@Y25  +'</ContactTelephone>
                            <ContactEmail>'+@AD30  +'</ContactEmail>
                            <BusinessName>'+ @C3  +'</BusinessName>
                            <AddressLine1>'+@D4  +'</AddressLine1>
                            <AddressLine2>'+@E5  +'</AddressLine2>
                            <AddressLine3>'+@F6  +'</AddressLine3>
                            <AddressLine4>'+@G7 +'</AddressLine4>
                            <PostCode>'+@H8 +'</PostCode>
                            <CountryCode>>'+@I9 +'</CountryCode>
                        </CollectionAddress>
                        <References>
                            <Reference>
                                <ReferenceName>name</ReferenceName>
                                <ReferenceValue>'+@Z26 +'</ReferenceValue>
                                <ParcelNumber>1</ParcelNumber>
                            </Reference>
                            <Reference>
                                <ReferenceName>ref3</ReferenceName>
                                <ReferenceValue>'+@AA27 +'</ReferenceValue>
                                <ParcelNumber>2</ParcelNumber>
                            </Reference>
                        </References>
                    </Consignment>
                </PreAdvice>'
                
                labelResponse = RestClient.post "https://papi.dpd.ie/common/api/preadvice", xmlPayloadAuthorised, 
                {content_type: :xml, accept: :xml, authorization: "Bearer " + accessToken}
                
                #parce the xml to get the access token
                xmlLabelDoc  = Nokogiri::XML(labelResponse)
                #get the access token
                @labelURI = xmlLabelDoc.xpath("//LabelImage").text
                
                @responseXML = xmlLabelDoc
                
                 
                ###############
                ####redirects to url with a label
                
                
                @labelsArray2.push(@labelURI)
                ###@labelsArrayDB = @labelsArrayDB +" "+ @labelURI
                ##@labelsArrayDB =  @labelURI +'~'+ @labelURI
                 ### @labelsArrayDB = @labelsArray2.map(&:inspect).join('') 
                 
            
                
                #######cookies[:cookeslabelsArray2] = cookies[:cookeslabelsArray2] +'~'+ @labelURI
                @debug10 = true
                
                ##################
    
    
    */
    
    
    
    
    
    
    var csvSingleForeachJS = '<%=CSV.read(@file5JSx)[1][3].inspect.gsub!('"', '')%>';
     console.log("csvSingleForeachJS = "+csvSingleForeachJS);
     
     
    
    var csvForeachJS;
 
    var csvForeachJSReplace = csvReadJS.replace(/&quot;/g,'');
    console.log("csvForeachJS split = "+csvForeachJSReplace);
       var csvForeachJS = csvForeachJSReplace.split(",");
     console.log("csvForeachJS = "+csvForeachJS[2]);
     
     
 
/*     
  if(csvForeachJS.length >= 1){      
     //Open all the urls
   var j = 1;
   while (j < csvForeachJS.length){
       /// console.log("labels array------loop-------- = "+labelsArray[o].slice(0, -5));
       //var tempURL = labelsArray[o].slice(0, -5)
       var tempURLJS = csvForeachJS[j].slice(0, -1)
     window.open(tempURLJS, '_blank'); 
       j = j+ 2;
   }
   csvForeachJS = [];
  }
  */
   
  
     
     //COMMENT OUT BECAUSE THIS WILL BE CALLED ON CLICK MAKE IT A FUNCTION AN CALL INCLICK?
     var authorizeCall = '<%=
     
     xmlPayloadAuthorise = 
                '<?xml version="1.0" encoding="iso-8859-1"?>
                <Request>
                <User>'+@accountNumber+'</User>
                <Password>'+@password+'</Password>
                <Type>CUST</Type>
                </Request>'
                
                authorizeResponce = RestClient.post "https://papi.dpd.ie/common/api/authorize", xmlPayloadAuthorise, 
                {content_type: :xml, accept: :xml, authorization: 'Bearer '+@token+''}
                
                #parce the xml to get the access token
                xmlAuthorizeDoc  = Nokogiri::XML(authorizeResponce)
                #get the access token
                accessToken = xmlAuthorizeDoc.xpath("//AccessToken").text
                %>';
     //
     console.log("authorizeCall = "+authorizeCall);
     
     //cookies from JS to Ruby
     //set cookies
     //document.cookie = "A1=" +  csvForeachJS[0] +  ";";
 //var url='https://papi.dpd.ie/common/api/preadvice';
  var method = 'POST'
  
  const invocation = new XMLHttpRequest();
const url = 'https://papi.dpd.ie/common/api/preadvice';
const body = '<?xml version="1.0" encoding="iso-8859-1"?><PreAdvice><Consignment>'+
'<RecordID>1</RecordID><CustomerAccount>1111L1</CustomerAccount><DeliveryDepot>0</DeliveryDepot><Gazzed>1</Gazzed>'+
'<ConsignmentCreationDateTime>2017-12-15T09:03:17</ConsignmentCreationDateTime><GazzType>PreAdvice</GazzType><TrackingNumber>0</TrackingNumber>'+
'<TotalParcels>1</TotalParcels><Relabel>1</Relabel><ServiceOption>5</ServiceOption><ServiceType>1</ServiceType><DeliveryAddress>'+
'<Contact></Contact><ContactTelephone>090 6420500</ContactTelephone><ContactEmail>test@dpd.ie</ContactEmail><BusinessName>Test Name</BusinessName>'+
'<AddressLine1>Dublin Road</AddressLine1><AddressLine2>Business Park</AddressLine2><AddressLine3>Athlone</AddressLine3><AddressLine4>Westmeath</AddressLine4>'+
'<PostCode></PostCode><CountryCode>IE</CountryCode></DeliveryAddress><CollectionAddress><Contact>TM</Contact>'+
'<ContactTelephone>0906420500</ContactTelephone><ContactEmail>tomas.mroszczyk@dpd.ie</ContactEmail>'+
'<BusinessName>ADVANCED TECHNOLOGY PRODUCTS</BusinessName><AddressLine1>CORCANREE B/P</AddressLine1><AddressLine2>DOCK ROAD</AddressLine2>'+
'<AddressLine3>Limerick</AddressLine3><AddressLine4>Limerick</AddressLine4><PostCode></PostCode><CountryCode>IE</CountryCode>'+
'</CollectionAddress><ReturnAddress><Contact>David McG</Contact><ContactTelephone>0906420500</ContactTelephone>'+
'<ContactEmail>integrations@dpd.ie</ContactEmail><BusinessName>ADVANCED TECHNOLOGY PRODUCTS (WS)</BusinessName>'+
'<AddressLine1>CORCANREE B/P</AddressLine1><AddressLine2>DOCK ROAD</AddressLine2><AddressLine3>Limerick</AddressLine3>'+
'<AddressLine4>Limerick</AddressLine4><PostCode></PostCode><CountryCode>IE</CountryCode></ReturnAddress>'+
'<PackingList/><ParcelDetails/><References><Reference><ReferenceName></ReferenceName><ReferenceValue>100</ReferenceValue>'+
'<ParcelNumber>1</ParcelNumber></Reference></References><Notes/></Consignment></PreAdvice>';


 function gapiACL() {
      var xhr = new XMLHttpRequest();
      var requestURL = url; 
      var params = {role: "writer",
                      scope: {
                        type: "user",
                        value: "rosamesarina@gmail.com"         
                      }
                    };


       var paramsjasonString = JSON.stringify(params); // convert the javascript object to a Json string
       console.log("paramsjasonString = " + paramsjasonString);

      // xhr.open('POST', requestURL + '?access_token=' +authorizeCall, true );
       xhr.open('POST', requestURL , true );
       //xhr.withCredentials = true;
       // Specify the http content-type as json
       
        xhr.setRequestHeader(
         'Content-Type', 'application/xml');
         
        //xhr.setRequestHeader('Bearer ' + authorizeCall);
         //xhr.setRequestHeader('Authorization', 'Bearer '+authorizeCall);
         //xhr.setRequestHeader('X-PINGOTHER', 'pingpong');
          

       // Response handlers
       xhr.onload = function() {
         var responseText = xhr.responseText;
         console.log(responseText);
         // process the response.
       };

      xhr.onerror = function() {
        console.log('There was an error!');
      };
      xhr.send(body);


    }
    gapiACL();
    

function CallWebAPI() {
    var request_ = new XMLHttpRequest();        
    //var encodedParams = encodeURIComponent(params);
    request_.open("POST", url, true);
    request_.setRequestHeader("Authorization", "Bearer "+ authorizeCall);
    request_.send(body);
    request_.onreadystatechange = function () {
        if (request_.readyState == 4 && request_.status == 200) {
            var response = request_.responseText;
            var obj = JSON.parse(response); 
            // handle data as needed... 

        }
    }
}
//////////// CallWebAPI();

           
                //labelResponse = RestClient.post "https://papi.dpd.ie/common/api/preadvice", xmlPayloadAuthorised, 
               // {content_type: :xml, accept: :xml, authorization: "Bearer " + accessToken}

  
     
 ///  var preadviceCall = '<%##=   xmlPayloadAuthorised = 
                '<?xml version="1.0" encoding="iso-8859-1"?>
                <PreAdvice>
                    <Consignment>
                        <RecordID>'+ cookies[:A1]+  '</RecordID>
                        <AlertEmailAddress>'+ csvForeachJS[29] +  '</AlertEmailAddress>
                        <ConsignmentDescription>LG.124132D</ConsignmentDescription>
                        <ConsignmentDate>2018-12-03</ConsignmentDate>
                        <CustomerAccount>1111L1</CustomerAccount>
                        <DeliveryDepot>0</DeliveryDepot>
                        <Gazzed>0</Gazzed>
                        <GazzType>PreAdvice</GazzType>
                        <TrackingNumber>0</TrackingNumber>
                        <TotalParcels>1</TotalParcels>
                        <Relabel>1</Relabel>
                        <ServiceOption>5</ServiceOption>
                        <ServiceType>1</ServiceType>
                        <Weight>10</Weight>
                        <DeliveryAddress>
                            <Contact>'+ csvForeachJS[23] +'</Contact>
                            <ContactTelephone>'+csvForeachJS[24]  +'</ContactTelephone>
                            <ContactEmail>'+csvForeachJS[29] +'</ContactEmail>
                            <BusinessName>'+csvForeachJS[2] +'</BusinessName>
                            <AddressLine1>'+csvForeachJS[3]  +'</AddressLine1>
                            <AddressLine2>'+csvForeachJS[4] +'</AddressLine2>
                            <AddressLine3>'+csvForeachJS[5]  +'</AddressLine3>
                            <AddressLine4>'+csvForeachJS[6] +'</AddressLine4>
                            <PostCode>'+csvForeachJS[7] +'</PostCode>
                            <CountryCode>'+csvForeachJS[8] +'</CountryCode>
                        </DeliveryAddress>
                        <CollectionAddress>
                           <Contact>'+ csvForeachJS[23] +'</Contact>
                            <ContactTelephone>'+csvForeachJS[24]  +'</ContactTelephone>
                            <ContactEmail>'+csvForeachJS[29] +'</ContactEmail>
                            <BusinessName>'+csvForeachJS[2] +'</BusinessName>
                            <AddressLine1>'+csvForeachJS[3]  +'</AddressLine1>
                            <AddressLine2>'+csvForeachJS[4] +'</AddressLine2>
                            <AddressLine3>'+csvForeachJS[5]  +'</AddressLine3>
                            <AddressLine4>'+csvForeachJS[6] +'</AddressLine4>
                            <PostCode>'+csvForeachJS[7] +'</PostCode>
                            <CountryCode>'+csvForeachJS[8] +'</CountryCode>
                        </CollectionAddress>
                        <References>
                            <Reference>
                                <ReferenceName>name</ReferenceName>
                                <ReferenceValue>'+csvForeachJS[25] +'</ReferenceValue>
                                <ParcelNumber>1</ParcelNumber>
                            </Reference>
                            <Reference>
                                <ReferenceName>ref3</ReferenceName>
                                <ReferenceValue>'+csvForeachJS[26] +'</ReferenceValue>
                                <ParcelNumber>2</ParcelNumber>
                            </Reference>
                        </References>
                    </Consignment>
                </PreAdvice>'
                
                labelResponse = RestClient.post "https://papi.dpd.ie/common/api/preadvice", xmlPayloadAuthorised, 
                {content_type: :xml, accept: :xml, authorization: "Bearer " + accessToken}
                
                #parce the xml to get the access token
                xmlLabelDoc  = Nokogiri::XML(labelResponse)
                #get the access token
                @labelURI = xmlLabelDoc.xpath("//LabelImage").text
                
                @responseXML = xmlLabelDoc
                 %>';
     //
     //console.log("preadviceCall = "+preadviceCall);
     
/*     
    
     //Open all the urls
   var d = 1;
   while (d < labelsArrayDB.length){
       /// console.log("labels array------loop-------- = "+labelsArray[o].slice(0, -5));
       //var tempURL = labelsArray[o].slice(0, -5)
       var tempURLDB = labelsArrayDB[d].slice(0, -1)
     window.open(tempURLDB, '_blank'); 
       d = d+ 2;
   }
   
  */
  /*
   //Open all the urls
   var c = 1;
   while (c < cookiesLabelsArrayC.length){
       /// console.log("labels array------loop-------- = "+labelsArray[o].slice(0, -5));
       //var tempURL = labelsArray[o].slice(0, -5)
       var cookiesTempURLC = cookiesLabelsArrayC[c].slice(0, -1)
     window.open(cookiesTempURLC, '_blank'); 
       c = c+ 2;
   }
   */
   
 
/*
   //Open all the urls
   var o = 1;
   while (o < labelsArrayC.length){
       /// console.log("labels array------loop-------- = "+labelsArray[o].slice(0, -5));
       //var tempURL = labelsArray[o].slice(0, -5)
       var tempURLC = labelsArrayC[o].slice(0, -1)
    window.open(tempURLC, '_blank'); 
       o = o+ 2;
   }
 
*/   

   //FUNCTION - OPENS ALL LABEL URLS
    function printLabels(){
        console.log("clicked print labels button**");
        //reload before print so that lates file is loaded
         document.cookie = "print=true;";
        location.reload();


        }
        
        
        
</script>

<%=
        @print = cookies[:print]
        unless @print.nil?
            if cookies[:print] == 'true'
           
            
         end     
  end
%>

<%#= render "login" %>
<%## email = <DPD Account Number><API Setup Password><Base64 Token><@dpd.ie> %>

<p<%= @accountNumber = @email[0, 6] %></p>
<p><%= @password = @email[6, 10] %></p>
<p><%= @token = @email[16..-8] %></p>
<!--
-->

<%###only for the initial deployment to Heroku DELETE %>
<%#= @accountNumber = '5287L9' %>
<%#= @password = 'db44t66Dat' %>
<%#= @token = 'R3JlZW5JVDpHcmVlbklUUGFzc3cwcmQyMDE4' %>


<%#= render "button" %>



<div class="container">
  <div class="row">
    <label class=" float-right">
      <h3>Print All Labels</h3>
      <button id ="print" class ="btn btn-print btn-lg " onclick="printLabels()">Print Labels</button>
    </label>
        
        
    <h3 id="ftpText"></h3>
    <br>
    <label class="switch">
      <br>
      <input type="checkbox" id="slider" onchange="isFTP()" >
      <span class="slider round"></span>
    </label>
  </div>
</div>
<hr />

<div class="container">
  <div class="row">
    <div class="purple-box u-padding-Al">
      <center>
         <h3>Local File Upload</h3>
         <%= render "upload" %>
      </center>
    </div>
    <hr />
  </div>
  

<br />
<%= button_to "File Mapping", new_mapping_path, class: "btn btn-primary"  %>
   

  <div class="row">
    <div class="col-md-12">

<%#DELETE%>        
<%###@isFtp = true%>
<%###@isFtp2 = true%>  
<%###@isFtp = true%>  
<%#DELETE%>  

     
        

<%if cookies[:print] == 'true'%> 
<%=
     
                #Read from FTP__________________________________________
                ftp = Net::FTP::new("ftp.dpd.ie")
                ftp.login("3L4", "3l4123")
                ftp.chdir("/users/3L4/WebAppImport")
                ## files = ftp.list
                ftp.passive = true
                ##file is downloaded from ftp to a local folder name "FromFTP"
                ftp.getbinaryfile("OurFormatEmailVadimTest.csv", "FromFTP")
                #tgz = ftp.list("ruby-*.tar.gz").sort.last
                #print "the latest version is ", tgz, "\n"
                #ftp.getbinaryfile(tgz, tgz)
                ftp.close
        
              
          
                # If on LOCAL_____________________________________________________________________________________________________
                if  @isFTP2.isFTP == false                    ############ORIGINAL LINE  isFtp.isFTP == false    
                    #if on DEVELOPMENT LOCAL-----------------------------------------------
                    ###CHANGE LATER
                    if @deployment == false
                        @debug3 = true
                          @csvFileLocationOpen = open('https://label-gen-var2.herokuapp.com/uploads/resume/attachment/1/OurFormatTest.csv')
                        open('OurFormatTest.csv', 'wb') do |file|
                           file << open('https://label-gen-var2.herokuapp.com/uploads/resume/attachment/1/OurFormatTest.csv').read
                           @file5 = file
                           
                         end
                 
                

            #read that variable
          ###  @csvRead = CSV.read(@file5)
          ####  @csvLenght = @csvRead.length
        
            else
                @debug11 = true
                @print = false
                
                cookies[:print] = "false" 
            
            end
                 
         @debug12 = true      
   end   

  ###  end
%>             
   <script>
   var csvRead2JS =  '<%=@csvRead%>'; 
 console.log("csvRead2JS = "+csvRead2JS);
 /*  
   var cname = 'print';  function getCookie(cname) {
  var name = cname + "=";
  var decodedCookie = decodeURIComponent(document.cookie);
  var ca = decodedCookie.split(';');
  for(var i = 0; i <ca.length; i++) {
    var c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}  

var printCookieJS = getCookie(cname); 
 console.log("printCookieJS = "+printCookieJS);
 */

   var labelsArray2JSRuby = '<%=@labelsArray2%>';
   console.log("labelsArray2JSRuby= " + labelsArray2JSRuby);
   var labelsString2JS;
    var labelsArray2JS;
    // if(printCookieJS == 'true'){
     //labelsArray2JS = labelsArray2JS.split("quot;");
  //console.log("label DB label array labelsArray2JS= "+labelsArray2JS); 
  labelsString2JS = labelsArray2JSRuby.replace(/&quot;/g,'');
    console.log("labelsString2JS split = "+labelsString2JS);
       var labelsArray2JS = labelsString2JS.split(",");
     console.log("labelsArray2JS = "+labelsArray2JS);
     console.log("labelsArray2JS.length = "+labelsArray2JS.length);

/*  
  if(labelsArray2JS.length >= 1){      
     //Open all the urls
   var j = 1;
   while (j < labelsArray2JS.length){
       /// console.log("labels array------loop-------- = "+labelsArray[o].slice(0, -5));
       //var tempURL = labelsArray[o].slice(0, -5)
       var tempURLJS = labelsArray2JS[j].slice(0, -1)
     window.open(tempURLJS, '_blank'); 
       j = j+ 2;
   }
  }
   */
  
//  }
 
 </script> 

<%end%>  
 
 <script>
    var statusFTP = '<%=@isFTP2.isFTP%>'; 
  console.log("isFTP STATUS= " + statusFTP);
//empty an array at the beginning
var labelsArray = [];

var isFtp = '<%=@isFtp%>';

 </script>

</head>
<body>
<%
@isFTP2 = @isFTP2.isFTP
%>
<script>
 var isFTP2 = '<%=@isFTP2%>';
 var debug = '<%=@debug%>';
 console.log("debug="+debug);
</script>


<%#first check the value of what checkbox should be%>
<script>

     console.log('this is first isFTP2 var ' + isFTP2);
    if (isFTP2 == 'false'){
        document.getElementById("slider").checked = false;
        ftpText.innerText = "Local Import is ON";
     
    }
    else if (isFTP2 == 'true'){
        document.getElementById("slider").checked = true;
         ftpText.innerText = "FTP Import is ON";
    }
  

    </script>


    <script>
  
    console.log(slider);
    
    function isFTP (){  
        var slider=document.getElementById("slider").checked;
        if (slider==false){
              console.log(slider);
            
      document.cookie = "cl=" + slider +  ";";
        location.reload();
        }
        else if (slider==true){
            document.cookie = "cl=" + slider +  ";";
              location.reload();
        }
        //document.getElementById("slider").value = false;
      
    
        }
    
</script>

<br>
<br>
<br>
<br>



            <!--
      
  
  
<!--___________________________________________________________________________ uncomment ALL to auto download the labels-->

<h3>XML Response</h3>
<br>
    <p><%=@responseXML%></p>
<script>
function print(){
    consosle.log("print");
}


//save a array now to attach one by one and then at the end run script to print an array ech element - make an array of urls and then call all the array until lenght

//get the array of labels URLs and push to an array

//if (labelUri.length < 50) {
//    var my_window = window.open('<%####= @labelURI %>', '_blank');
// }
 </script>
<!--___________________________________________________________________________ uncomment ALL to auto download the labels--> 
 


<%#= creates a label link/button for each label%>
<%#= link_to "LABEL",@labelURI,  :class => "a", :target => "_blank"%>
                                          
                                     <!--
<%
@labelURI
# link_to labelURI, target: :_blank 

%>


      
<%= button_to 'Press me',:controller => :welcome, :action => :button %>
<p><%= @button %></p>
 <script>
       
             var btn = '<%=@button %>'; 
               console.log(btn);
                 
           </script>
<%= 

#submit_tag("Checkout"), onclick: "print();"

#doc = Nokogiri::HTML(open("http://www.threescompany.com"))
#doc = Nokogiri::HTML(open(labelURI))
%>         
      <center>
        <ul class="no-bullet">
          <%# @bulletin_list.each do |bulletin| %>
            <li>
              <%# if bulletin.attachment.previewable? %>
                <%#= link_to(image_tag(bulletin.attachment.preview(resize: "200x200>")),  rails_blob_path(bulletin.attachment, disposition: "attachment"))
                #%>
              <%# elsif bulletin.attachment.variable? %>
                <%#= link_to(image_tag(bulletin.attachment.variant(resize: "200x200")), rails_blob_path(bulletin.attachment, disposition: "attachment"))%>
              <%# else %>
                <%#= link_to "Download file", rails_blob_path(bulletin.attachment, disposition: "attachment") %>
              <%# end %>
            </li>
          <%# end %>
        </ul>
      </center>
    </div>
  </div> <!-- row -->
</div>



        <%else%>
        
       <% end%>